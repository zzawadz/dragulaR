# AGENTS.md - Guidelines for AI Agents

This document provides guidance for AI agents (such as Claude, GitHub Copilot, etc.) working on the dragulaR package.

## Package Overview

dragulaR is an R package that wraps the [dragula JavaScript library](https://github.com/bevacqua/dragula) to enable drag-and-drop functionality within Shiny applications.

**Key Technologies:**
- R (primary language)
- JavaScript (htmlwidgets binding)
- Shiny (web framework)
- htmlwidgets (R-JS bridge)

## Repository Structure

```
dragulaR/
├── R/                      # R source files
│   └── dragula.R           # Main package functions
├── inst/
│   ├── htmlwidgets/        # JavaScript widget code
│   │   ├── dragula.js      # Widget binding
│   │   ├── dragula.yaml    # Widget dependencies
│   │   └── dragula-3.7.2/  # Bundled dragula library
│   └── apps/               # Example Shiny applications
├── tests/
│   └── testthat/           # Unit tests
├── man/                    # Documentation (auto-generated by roxygen2)
├── docs/                   # pkgdown website
├── DESCRIPTION             # Package metadata
└── NAMESPACE               # Exports (auto-generated by roxygen2)
```

## Development Guidelines

### R Code (R/dragula.R)

1. **Documentation**: Use roxygen2 comments (`#'`) for all exported functions
2. **Exports**: Add `@export` tag for public functions
3. **Imports**: Use `@importFrom package function` for specific imports
4. **After changes**: Run `devtools::document()` to regenerate NAMESPACE and man/ files

### JavaScript Code (inst/htmlwidgets/dragula.js)

1. **htmlwidgets pattern**: Follow the `HTMLWidgets.widget()` factory pattern
2. **Shiny integration**: Use `Shiny.onInputChange()` to send data to R
3. **Event handling**: Attach to dragula's `drop` and `remove` events
4. **Global state**: Use the `dragulaR` Map for refresh callbacks

### Testing

1. **Framework**: testthat
2. **Run tests**: `devtools::test()` or `R CMD check`
3. **Test location**: `tests/testthat/`
4. **Naming**: Test files should be named `test-*.R`

### Example Apps

1. **Location**: `inst/apps/`
2. **Naming convention**: `exampleNN-description/app.R`
3. **Purpose**: Demonstrate features and serve as integration tests
4. **Run an app**: `shiny::runApp(system.file("apps/example01-dragula", package = "dragulaR"))`

## Common Tasks

### Adding a New Feature

1. Implement in `R/dragula.R` (R side) and/or `inst/htmlwidgets/dragula.js` (JS side)
2. Add roxygen2 documentation for new R functions
3. Run `devtools::document()` to update NAMESPACE and man/
4. Write tests in `tests/testthat/`
5. Create an example app in `inst/apps/` if applicable
6. Run `R CMD check` to verify no errors or warnings

### Adding Dragula Options

The dragula JS library supports various options (see [dragula docs](https://github.com/bevacqua/dragula#dragulacontainers-options)). To add support for a new option:

1. Options are passed via `...` in `dragula()` function
2. For complex options requiring JS functions, use `V8::JS()` wrapper
3. For convenience shortcuts (like `copyOnly`), add special handling in `dragula()`

### Updating the Bundled Dragula Library

1. Download the new version from npm or GitHub
2. Place files in `inst/htmlwidgets/dragula-X.Y.Z/`
3. Update `inst/htmlwidgets/dragula.yaml` to point to new version

## Key Functions

| Function | Purpose |
|----------|---------|
| `dragula(x, ...)` | Register containers for drag-and-drop |
| `dragulaOutput(outputId)` | UI placeholder for reactive dragula |
| `renderDragula(expr)` | Server-side renderer for dragula |
| `dragulaValue(x)` | Format input$dragula for easier use |
| `useDragulajs()` | Enable dynamic element refresh |

## Important Notes

1. **Elements must have `drag` attribute**: Only elements with `drag="identifier"` are tracked
2. **Container IDs**: Containers are identified by their HTML `id` attribute
3. **Dynamic elements**: After adding elements with `insertUI()`, call `js$refreshDragulaR("dragula")`
4. **renderUI issue**: There's a known issue where users must interact with dragula after `renderUI()` to refresh state

## Build and Check Commands

```r
# Install dependencies
devtools::install_deps()

# Run tests
devtools::test()

# Check package
devtools::check()

# Build documentation
devtools::document()

# Build pkgdown site
pkgdown::build_site()
```

## Code Style

- Use snake_case for R function names (where practical)
- Use 2-space indentation in R code
- Follow existing patterns in the codebase
- Keep JavaScript compatible with ES5 for broader browser support

## Files Excluded from Package Build

See `.Rbuildignore` for files excluded from the built package (e.g., docs/, README.md, CI config files).
